<!DOCTYPE html>
<html lang="zh-CN" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Word2HTML - 文档转换工具</title>
    <!-- TailwindCSS 和自定义样式 -->
    <link rel="stylesheet" href="./dist/output.css" />
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="./src/styles.css" />
    <!-- Preline UI 组件库 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/preline/dist/preline.min.css"
    />
    <!-- Font Awesome 图标库 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Prism.js 代码高亮 -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <!-- 代码高亮模块 -->
    <script src="highlight.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <!-- Preline UI JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/preline/dist/preline.js"></script>
    <!-- html2canvas 库用于将HTML保存为图片 -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- 硅基流动API调用模块 -->
    <script src="api.js"></script>
    <!-- mammoth.js 用于处理Word文档 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  </head>
  <body>
    <!-- 主要内容区域 -->
    <div class="container mx-auto px-4 py-8">
      <!-- 标题区域 -->
      <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">
          Word2HTML
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">
          将文档转换为美观的HTML页面
        </p>
      </div>

      <!-- 主要功能区域 -->
      <div class="max-w-4xl mx-auto">
        <!-- 输入选择区域 -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8">
          <div class="flex space-x-4 mb-6">
            <button
              id="file-input-btn"
              class="flex-1 py-3 px-6 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium text-center transition-all hover:shadow-md border border-gray-200 dark:border-gray-600 hover:border-primary-500 dark:hover:border-primary-500 active:scale-95 cursor-pointer flex items-center justify-center"
            >
              <i class="fas fa-file-upload mr-2"></i>上传文件
            </button>
            <button
              id="text-input-btn"
              class="flex-1 py-3 px-6 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium text-center transition-all hover:shadow-md border border-gray-200 dark:border-gray-600 hover:border-primary-500 dark:hover:border-primary-500 active:scale-95 cursor-pointer flex items-center justify-center"
            >
              <i class="fas fa-keyboard mr-2"></i>输入文本
            </button>
          </div>

          <!-- 文件上传区域 -->
          <div id="file-input-section" class="mb-6" style="display: block">
            <div
              class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary-500 transition-all"
            >
              <input
                type="file"
                id="file-upload"
                class="hidden"
                accept=".txt,.md,.docx,.doc"
              />
              <label
                for="file-upload"
                class="cursor-pointer flex flex-col items-center justify-center"
              >
                <i
                  class="fas fa-cloud-upload-alt text-4xl text-gray-400 dark:text-gray-500 mb-4"
                ></i>
                <p class="text-gray-700 dark:text-gray-300 mb-2">
                  拖放文件到此处或
                  <span class="text-primary-600 dark:text-primary-400"
                    >浏览文件</span
                  >
                </p>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  支持 TXT, Markdown, Word 文档
                </p>
                <p class="text-sm text-yellow-500 mt-2">
                  <i class="fas fa-exclamation-triangle mr-1"></i
                  >建议内容不超过10000字符，超过可能影响转换质量
                </p>
              </label>
            </div>

            <!-- 文件信息 -->
            <div id="file-info" class="mt-4 hidden">
              <div
                class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 rounded-lg p-3"
              >
                <div class="flex items-center">
                  <i
                    class="fas fa-file-alt text-primary-500 dark:text-primary-400 mr-3"
                  ></i>
                  <span
                    id="file-name"
                    class="text-gray-700 dark:text-gray-300"
                  ></span>
                </div>
                <button
                  id="remove-file"
                  class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- 文本输入区域 -->
          <div id="text-input-section" class="mb-6" style="display: none">
            <div class="flex items-center gap-2 mb-2">
              <div class="flex-1">
                <p class="text-sm text-yellow-500">
                  <i class="fas fa-exclamation-triangle mr-1"></i
                  >建议内容不超过10000字符，超过可能影响转换质量
                </p>
              </div>
              <button
                id="ai-generate-btn"
                class="ai-btn flex items-center gap-2 px-4 py-2 text-sm font-medium text-white transition-all duration-200 ease-in-out rounded-lg"
                title="AI生成文字"
              >
                <i class="fas fa-robot"></i>
                <span>AI生成</span>
              </button>
            </div>
            <div class="relative">
              <textarea
                id="text-content"
                class="w-full h-64 p-4 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                placeholder="在此输入您的文本内容..."
                maxlength="20000"
              ></textarea>
            </div>
            <div class="flex justify-end mt-2">
              <p class="text-sm text-gray-500 dark:text-gray-400">
                字符数: <span id="char-count">0</span> / 20000
              </p>
            </div>
          </div>

          <!-- 转换按钮 -->
          <div class="text-center">
            <button
              id="convert-btn"
              class="py-3 px-6 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all"
            >
              <i class="fas fa-magic mr-2"></i><span>转换为HTML</span>
            </button>
          </div>
        </div>

        <!-- 结果区域 -->
        <div
          id="result-section"
          class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-8 hidden"
        >
          <h3 class="text-xl font-semibold mb-4">生成的HTML代码</h3>

          <!-- 进度指示器 -->
          <div id="progress-indicator" class="mb-4 hidden">
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
              <div
                class="bg-primary-600 h-2.5 rounded-full animate-pulse"
                style="width: 100%"
              ></div>
            </div>
            <p
              class="text-sm text-gray-500 dark:text-gray-400 mt-2 text-center"
            >
              正在生成HTML...
            </p>
          </div>

          <!-- 代码预览 -->
          <div class="preview-container">
            <pre><code id="html-code" class="language-html"></code></pre>
          </div>

          <!-- 操作按钮 -->
          <div class="flex flex-wrap gap-3 mt-6">
            <button
              id="copy-html-btn"
              class="py-2 px-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-all flex items-center"
            >
              <i class="fas fa-copy mr-2"></i>复制代码
            </button>
            <button
              id="preview-btn"
              class="py-2 px-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-all flex items-center"
            >
              <i class="fas fa-eye mr-2"></i>预览
            </button>
            <button
              id="download-html-btn"
              class="py-2 px-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-all flex items-center"
            >
              <i class="fas fa-download mr-2"></i>下载HTML
            </button>
            <button
              id="download-image-btn"
              class="py-2 px-4 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-all flex items-center"
            >
              <i class="fas fa-image mr-2"></i>保存为图片
            </button>
          </div>

          <!-- URL显示区域 -->
          <div id="url-section" class="mt-6 hidden">
            <div
              class="flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"
            >
              <i class="fas fa-link text-primary-500"></i>
              <input
                type="text"
                id="page-url"
                class="flex-1 bg-transparent border-none focus:ring-0 text-gray-700 dark:text-gray-300"
                readonly
              />
              <button
                id="copy-url-btn"
                class="py-1 px-3 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-300 rounded transition-all"
              >
                复制链接
              </button>
              <a
                id="open-url-btn"
                target="_blank"
                class="py-1 px-3 bg-primary-600 hover:bg-primary-700 text-white rounded transition-all inline-flex items-center"
              >
                <i class="fas fa-external-link-alt mr-1"></i>
                打开页面
              </a>
            </div>
          </div>
        </div>

        <!-- 预览区域 -->
        <div id="preview-section" class="mb-8 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">预览</h3>
            <div
              id="preview-content"
              class="prose dark:prose-invert max-w-none"
            >
              <!-- 预览内容将在这里动态插入 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 深色模式切换按钮 -->
    <button
      id="theme-toggle"
      class="fixed top-6 right-24 p-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all z-50"
    >
      <i class="fas fa-moon dark:hidden"></i>
      <i class="fas fa-sun hidden dark:block"></i>
    </button>

    <!-- API配置按钮 -->
    <button
      id="api-config-btn"
      class="fixed top-6 right-6 p-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all z-50"
    >
      <i class="fas fa-cog"></i>
    </button>

    <!-- 预览模态框 -->
    <div
      id="preview-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-11/12 max-w-5xl max-h-[90vh] flex flex-col"
      >
        <div
          class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700"
        >
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
            HTML预览
          </h3>
          <button
            id="close-preview"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 overflow-auto p-4">
          <iframe
            id="preview-iframe"
            class="w-full h-full border-0 rounded"
          ></iframe>
        </div>
      </div>
    </div>

    <!-- API配置模态框 -->
    <div
      id="api-config-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-11/12 max-w-md"
      >
        <div
          class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700"
        >
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
            API配置
          </h3>
          <button
            id="close-api-config"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="api-config-form" class="p-4">
          <div class="mb-4">
            <label
              for="api-key"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >API密钥</label
            >
            <input
              type="password"
              id="api-key"
              class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
              placeholder="输入您的API密钥"
              required
            />
          </div>
          <div class="mb-4">
            <label
              for="model-name"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >模型名称</label
            >
            <input
              type="text"
              id="model-name"
              class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
              placeholder="例如: gpt-4-turbo"
              required
            />
          </div>
          <div class="mb-6">
            <label
              for="api-url"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >API URL</label
            >
            <input
              type="url"
              id="api-url"
              class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
              placeholder="例如: https://api.openai.com/v1/chat/completions"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full py-2 px-4 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all"
          >
            保存配置
          </button>
        </form>
      </div>
    </div>

    <!-- AI生成文字模态框 -->
    <div
      id="ai-generate-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-11/12 max-w-lg"
      >
        <div
          class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700"
        >
          <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
            AI生成文字
          </h3>
          <button
            id="close-ai-generate"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-4">
          <div class="mb-4">
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >输入关键词（至少5个字）</label
            >
            <input
              type="text"
              id="ai-keywords"
              class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
              placeholder="请输入关键词，AI将基于此生成更多内容"
              minlength="5"
            />
          </div>
          <button
            id="start-generate"
            class="w-full py-2 px-4 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all"
          >
            开始生成
          </button>
        </div>
      </div>
    </div>

    <style>
      /* 修改按钮样式 */
      #ai-generate-btn {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        transition: all 0.3s ease;
      }

      #ai-generate-btn:hover {
        background: linear-gradient(135deg, #4338ca, #6d28d9);
        transform: translateY(-1px);
      }

      #ai-generate-btn:active {
        transform: translateY(0);
      }

      /* 提示文字样式 */
      #ai-generate-btn .group-hover\:opacity-100 {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      /* 加载动画样式 */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      #ai-generate-btn.loading {
        animation: pulse 1.5s infinite;
        background: linear-gradient(135deg, #3730a3, #6d28d9);
      }

      /* 确保文本域右侧有足够空间放置按钮 */
      #text-content {
        padding-right: 3rem !important;
      }

      /* AI按钮样式 */
      .ai-btn {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
        transform: translateY(0);
      }

      .ai-btn:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
        transform: translateY(-1px);
      }

      .ai-btn:active {
        transform: translateY(0);
      }

      .ai-btn.loading {
        background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      /* 优化文本区域样式 */
      #text-content {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        resize: vertical;
        min-height: 200px;
      }

      #text-content:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      /* 深色模式适配 */
      @media (prefers-color-scheme: dark) {
        .ai-btn {
          box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
        }

        .ai-btn:hover {
          box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        #text-content:focus {
          border-color: #8b5cf6;
          box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
      }
    </style>

    <script>
      // 使用highlight.js中定义的代码高亮初始化函数
      const { initializeCodeHighlight } = window.codeHighlight || {};

      // 在预览内容更新后调用代码高亮初始化
      function updatePreview(content) {
        const previewContent = document.getElementById("preview-content");
        previewContent.innerHTML = content;
        document.getElementById("preview-section").classList.remove("hidden");
        // 初始化代码高亮
        if (initializeCodeHighlight) {
          initializeCodeHighlight();
        }
      }

      // DOM元素
      let fileInputBtn,
        textInputBtn,
        fileInputSection,
        textInputSection,
        fileUpload,
        fileInfo,
        fileName,
        removeFile,
        textContent,
        convertBtn,
        resultSection,
        htmlCode,
        copyHtmlBtn,
        previewBtn,
        downloadHtmlBtn,
        downloadImageBtn,
        previewModal,
        previewIframe,
        closePreview,
        themeToggle,
        apiConfigBtn,
        apiConfigModal,
        closeApiConfig,
        apiConfigForm,
        apiKeyInput,
        modelNameInput,
        apiUrlInput;

      // 初始化所有DOM元素
      function initDomElements() {
        fileInputBtn = document.getElementById("file-input-btn");
        textInputBtn = document.getElementById("text-input-btn");
        fileInputSection = document.getElementById("file-input-section");
        textInputSection = document.getElementById("text-input-section");
        fileUpload = document.getElementById("file-upload");
        fileInfo = document.getElementById("file-info");
        fileName = document.getElementById("file-name");
        removeFile = document.getElementById("remove-file");
        textContent = document.getElementById("text-content");
        convertBtn = document.getElementById("convert-btn");
        resultSection = document.getElementById("result-section");
        htmlCode = document.getElementById("html-code");
        copyHtmlBtn = document.getElementById("copy-html-btn");
        previewBtn = document.getElementById("preview-btn");
        downloadHtmlBtn = document.getElementById("download-html-btn");
        downloadImageBtn = document.getElementById("download-image-btn");
        previewModal = document.getElementById("preview-modal");
        previewIframe = document.getElementById("preview-iframe");
        closePreview = document.getElementById("close-preview");
        themeToggle = document.getElementById("theme-toggle");
        apiConfigBtn = document.getElementById("api-config-btn");
        apiConfigModal = document.getElementById("api-config-modal");
        closeApiConfig = document.getElementById("close-api-config");
        apiConfigForm = document.getElementById("api-config-form");
        apiKeyInput = document.getElementById("api-key");
        modelNameInput = document.getElementById("model-name");
        apiUrlInput = document.getElementById("api-url");
      }

      // 初始化事件监听器
      function initEventListeners() {
        // 切换深色/浅色模式
        themeToggle.addEventListener("click", function () {
          console.log("切换主题");

          // 完全移除现有主题类并添加新主题类
          const isDark = document.documentElement.classList.contains("dark");
          document.documentElement.classList.remove("dark", "light");
          document.documentElement.classList.add(isDark ? "light" : "dark");

          localStorage.theme = isDark ? "light" : "dark";
          console.log("主题已切换为:", localStorage.theme);

          // 更新按钮状态
          updateThemeToggleButton(!isDark);
        });

        // 切换输入方式 - 文件上传
        fileInputBtn.addEventListener("click", function () {
          console.log("切换到文件上传");
          // 更新按钮样式
          fileInputBtn.style.backgroundColor = "#3B82F6"; // primary-500
          fileInputBtn.style.color = "white";
          fileInputBtn.style.borderColor = "#3B82F6"; // primary-500

          textInputBtn.style.backgroundColor = "";
          textInputBtn.style.color = "";
          textInputBtn.style.borderColor = "";

          // 显示/隐藏对应区域
          fileInputSection.style.display = "block";
          textInputSection.style.display = "none";
        });

        // 切换输入方式 - 文本输入
        textInputBtn.addEventListener("click", function () {
          console.log("切换到文本输入");
          // 更新按钮样式
          textInputBtn.style.backgroundColor = "#3B82F6"; // primary-500
          textInputBtn.style.color = "white";
          textInputBtn.style.borderColor = "#3B82F6"; // primary-500

          fileInputBtn.style.backgroundColor = "";
          fileInputBtn.style.color = "";
          fileInputBtn.style.borderColor = "";

          // 显示/隐藏对应区域
          textInputSection.style.display = "block";
          fileInputSection.style.display = "none";

          // 更新字符计数
          if (textContent && textContent.value) {
            document.getElementById("char-count").textContent =
              textContent.value.length;
          }
        });

        // 文本输入区域字符计数
        textContent.addEventListener("input", function () {
          const charCount = this.value.length;
          document.getElementById("char-count").textContent = charCount;

          // 当字符数超过10000时，添加警告样式
          const charCountElement = document.getElementById("char-count");
          if (charCount > 10000) {
            charCountElement.classList.add("text-red-500", "font-bold");
          } else {
            charCountElement.classList.remove("text-red-500", "font-bold");
          }
        });

        // 文件上传处理
        fileUpload.addEventListener("change", async function (e) {
          if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileName.textContent = file.name;
            fileInfo.classList.remove("hidden");

            // 检查文件大小（超过1MB可能表示内容较多）
            if (file.size > 1024 * 1024) {
              // 读取文件内容并检查字符数
              try {
                const content = await readFileContent(file);
                if (content.length > 10000) {
                  const warningEl = document.createElement("p");
                  warningEl.className = "text-xs text-red-500 mt-1";
                  warningEl.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>文件内容超过10000字符（${content.length}字符），可能影响转换质量`;

                  // 移除之前的警告（如果有）
                  const existingWarning =
                    fileInfo.querySelector(".text-red-500");
                  if (existingWarning) {
                    existingWarning.remove();
                  }

                  fileInfo.appendChild(warningEl);
                }
              } catch (err) {
                console.warn("读取文件内容失败:", err);
              }
            }
          }
        });

        // 移除上传的文件
        removeFile.addEventListener("click", function () {
          fileUpload.value = "";
          fileInfo.classList.add("hidden");
        });

        // 转换按钮点击事件
        convertBtn.addEventListener("click", async function () {
          console.log("转换按钮被点击");
          // 显示加载状态
          convertBtn.disabled = true;
          convertBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i><span>处理中...</span>';

          try {
            let content = "";

            // 获取输入内容
            if (
              fileInputSection.style.display === "block" &&
              fileUpload.files.length > 0
            ) {
              // 从文件获取内容
              const file = fileUpload.files[0];
              content = await readFileContent(file);
            } else if (
              textInputSection.style.display === "block" &&
              textContent.value.trim() !== ""
            ) {
              // 从文本区域获取内容
              content = textContent.value;
            } else {
              throw new Error("请提供内容");
            }

            // 检查内容长度是否超过10000字符
            if (content.length > 10000) {
              const confirmResult = confirm(
                `您输入的内容超过10000字符（当前${content.length}字符），文本过长可能会影响转换质量和速度。\n\n请精简内容后再试，或者点击"确定"继续处理。`
              );
              if (!confirmResult) {
                throw new Error("内容过长，请精简后再试");
              }
              console.log("用户确认继续处理长内容:", content.length, "字符");
            }

            // 显示结果区域和进度指示器
            resultSection.classList.remove("hidden");
            document
              .getElementById("progress-indicator")
              .classList.remove("hidden");
            htmlCode.textContent = "";
            resultSection.scrollIntoView({ behavior: "smooth" });

            // 调用API转换函数
            console.log("调用AI转换函数");

            // 检查是否已配置API
            if (!window.siliconFlowConfig) {
              // 尝试从本地存储加载
              if (!loadSavedApiConfig()) {
                // 如果未配置，弹出配置对话框
                apiConfigModal.classList.remove("hidden");
                throw new Error("请先配置API");
              }
            }

            const { apiKey, modelName, apiUrl } = window.siliconFlowConfig;

            // 准备发送给模型的提示词 (prm.md的内容)
            const promptPrefix = `根据用户提供文件或者内容，分析内容，并将其转化为美观漂亮的中文可视化网页：
## 内容要求
-直接输出html代码，不用输出任何解释性文字
- 所有页面内容必须为简体中文
- 保持原文件的核心信息，但以更易读、可视化的方式呈现
- 在页面底部添加作者信息区域，包含：    
- 作者姓名: []    
- - 社交媒体链接: 至少包含Twitter/X：    
- - 版权信息和年份
## 设计风格
- 整体风格参考Linear App的简约现代设计
- 使用清晰的视觉层次结构，突出重要内容- 配色方案应专业、和谐，适合长时间阅读
- 图标颜色需要丰富点，更符合互联网设计风格
## 技术规范
- 使用HTML5、TailwindCSS 3.0+（通过CDN引入）和必要的JavaScript- **使用CDN引入Preline UI组件库，按需使用其组件增强界面效果**- **根据提供的JSON文件内容（颜色、字体等）配置TailwindCSS的样式Token，确保设计一致性**- 实现完整的深色/浅色模式切换功能，默认跟随系统设置- 代码结构清晰，包含适当注释，便于理解和维护`;

            // 构建完整提示词
            const fullPrompt = `${promptPrefix}

用户内容:
${content}`;

            try {
              // 调用API
              const htmlResult = await window.siliconFlow.callAPI(
                fullPrompt,
                apiKey,
                modelName,
                apiUrl,
                (chunk, fullContent) => {
                  // 更新结果内容
                  htmlCode.textContent = fullContent;
                  // 高亮代码
                  Prism.highlightElement(htmlCode);
                }
              );

              // 隐藏进度指示器
              document
                .getElementById("progress-indicator")
                .classList.add("hidden");

              // 更新预览区域
              if (htmlResult && htmlResult.trim() !== "") {
                // 自动保存到服务器并生成URL
                try {
                  const finalContent = wrapWithStyles(htmlResult);
                  const response = await fetch("http://192.168.1.7:5000/save", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ html: finalContent }),
                  });

                  const data = await response.json();
                  if (data.success) {
                    // 显示URL区域
                    const urlSection = document.getElementById("url-section");
                    const pageUrl = document.getElementById("page-url");
                    const openUrlBtn = document.getElementById("open-url-btn");
                    const copyUrlBtn = document.getElementById("copy-url-btn");

                    if (urlSection && pageUrl && openUrlBtn) {
                      urlSection.classList.remove("hidden");
                      pageUrl.value = data.url;
                      openUrlBtn.href = data.url;

                      // 自动选择URL
                      pageUrl.select();

                      // 显示成功提示
                      console.log("URL已生成:", data.url);
                    }
                  } else {
                    console.error("生成URL失败:", data.error);
                    alert("生成URL失败: " + (data.error || "未知错误"));
                  }
                } catch (error) {
                  console.error("保存到服务器失败:", error);
                  alert("保存到服务器失败: " + error.message);
                }

                // 添加预览按钮功能
                previewBtn.onclick = function () {
                  previewIframe.srcdoc = htmlResult;
                  previewModal.classList.remove("hidden");
                };

                // 下载HTML功能
                downloadHtmlBtn.onclick = function () {
                  downloadFile(htmlResult, "converted.html", "text/html");
                };
              }
            } catch (error) {
              console.error("API调用失败:", error);
              throw new Error(`API调用失败: ${error.message}`);
            }
          } catch (error) {
            alert(`转换失败: ${error.message}`);
          } finally {
            // 恢复按钮状态
            convertBtn.disabled = false;
            convertBtn.innerHTML =
              '<i class="fas fa-magic mr-2"></i><span>转换为HTML</span>';
          }
        });

        // 复制HTML代码
        copyHtmlBtn.addEventListener("click", function () {
          const textToCopy = htmlCode.textContent;

          // 检查剪贴板API是否可用
          if (navigator.clipboard && navigator.clipboard.writeText) {
            // 现代浏览器 - 使用剪贴板API
            navigator.clipboard
              .writeText(textToCopy)
              .then(() => {
                showCopySuccess();
              })
              .catch((err) => {
                console.error("剪贴板写入失败:", err);
                fallbackCopy(textToCopy);
              });
          } else {
            // 降级方案 - 使用传统方式复制
            fallbackCopy(textToCopy);
          }

          // 显示复制成功
          function showCopySuccess() {
            const originalHTML = copyHtmlBtn.innerHTML;
            copyHtmlBtn.innerHTML = '<i class="fas fa-check mr-2"></i>已复制';
            setTimeout(() => {
              copyHtmlBtn.innerHTML = originalHTML;
            }, 2000);
          }

          // 降级复制方法
          function fallbackCopy(text) {
            try {
              // 创建临时textarea
              const textArea = document.createElement("textarea");
              textArea.value = text;
              textArea.style.position = "fixed";
              textArea.style.top = "0";
              textArea.style.left = "0";
              textArea.style.width = "2em";
              textArea.style.height = "2em";
              textArea.style.padding = "0";
              textArea.style.border = "none";
              textArea.style.outline = "none";
              textArea.style.boxShadow = "none";
              textArea.style.background = "transparent";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();

              const successful = document.execCommand("copy");
              document.body.removeChild(textArea);

              if (successful) {
                showCopySuccess();
              } else {
                alert("复制失败，请手动复制代码");
              }
            } catch (err) {
              console.error("复制失败:", err);
              alert("复制失败，请手动复制代码");
            }
          }
        });

        // 预览按钮
        previewBtn.addEventListener("click", function () {
          // 获取HTML内容并清理
          const cleanedContent = cleanHtmlContent(htmlCode.textContent);

          // 添加样式和框架
          const finalContent = wrapWithStyles(cleanedContent);

          // 显示预览
          previewIframe.srcdoc = finalContent;
          previewModal.classList.remove("hidden");

          // 调整模态框大小
          const previewModalDiv = document.querySelector(
            "#preview-modal > div"
          );
          previewModalDiv.style.width = "95%";
          previewModalDiv.style.height = "95vh";

          // 确保iframe高度正确，并添加更多的时间等待渲染完成
          setTimeout(() => {
            const iframe = document.getElementById("preview-iframe");
            if (iframe && iframe.parentElement) {
              // 设置iframe高度充满父容器
              iframe.style.height = "100%";
              iframe.style.minHeight = "80vh";

              // 尝试等待iframe加载完成后再调整高度
              iframe.onload = function () {
                this.style.height = this.parentElement.clientHeight + "px";

                // 尝试执行iframe内的Prism代码高亮
                try {
                  if (this.contentWindow && this.contentWindow.Prism) {
                    this.contentWindow.Prism.highlightAll();
                  }
                } catch (e) {
                  console.error("在iframe中执行代码高亮失败:", e);
                }
              };
            }
          }, 300);
        });

        // 关闭预览
        closePreview.addEventListener("click", function () {
          previewModal.classList.add("hidden");
        });

        // 点击模态框背景关闭
        previewModal.addEventListener("click", function (e) {
          if (e.target === previewModal) {
            previewModal.classList.add("hidden");
          }
        });

        // API配置按钮
        apiConfigBtn.addEventListener("click", function () {
          apiConfigModal.classList.remove("hidden");
        });

        // 关闭API配置
        closeApiConfig.addEventListener("click", function () {
          apiConfigModal.classList.add("hidden");
        });

        // API配置表单提交
        apiConfigForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const config = {
            apiKey: apiKeyInput.value,
            modelName: modelNameInput.value,
            apiUrl: apiUrlInput.value,
          };

          // 保存到全局变量
          window.siliconFlowConfig = config;

          // 保存到localStorage
          localStorage.setItem("siliconFlowConfig", JSON.stringify(config));

          apiConfigModal.classList.add("hidden");
          alert("API配置已保存");
        });

        // URL复制功能
        const copyUrlBtn = document.getElementById("copy-url-btn");
        const pageUrl = document.getElementById("page-url");

        if (copyUrlBtn && pageUrl) {
          copyUrlBtn.addEventListener("click", async function () {
            try {
              pageUrl.select();
              // 使用更安全的方式复制文本
              if (document.execCommand) {
                document.execCommand("copy");
                const originalText = copyUrlBtn.textContent;
                copyUrlBtn.textContent = "已复制";
                setTimeout(() => {
                  copyUrlBtn.textContent = originalText;
                }, 2000);
              } else {
                // 如果execCommand不可用，回退到clipboard API
                await navigator.clipboard.writeText(pageUrl.value);
                const originalText = copyUrlBtn.textContent;
                copyUrlBtn.textContent = "已复制";
                setTimeout(() => {
                  copyUrlBtn.textContent = originalText;
                }, 2000);
              }
            } catch (err) {
              console.error("复制URL失败:", err);
              // 提供更详细的错误信息
              alert("复制URL失败，请手动复制。错误详情：" + err.message);
            }
          });
        }

        // 打开URL功能
        const openUrlBtn = document.getElementById("open-url-btn");
        if (openUrlBtn) {
          openUrlBtn.addEventListener("click", function (e) {
            try {
              if (!this.href || this.href.trim() === "") {
                e.preventDefault();
                alert("URL尚未生成，请等待生成完成");
                return;
              }
              // 使用更安全的方式打开URL
              const url = new URL(this.href);
              if (!url.href) {
                throw new Error("无效的URL");
              }
            } catch (err) {
              e.preventDefault();
              console.error("打开URL失败:", err);
              alert("无法打开URL：" + err.message);
            }
          });
        }

        // 更新URL显示逻辑
        function updateUrlSection(url) {
          const urlSection = document.getElementById("url-section");
          const pageUrl = document.getElementById("page-url");
          const openUrlBtn = document.getElementById("open-url-btn");

          if (urlSection && pageUrl && openUrlBtn && url) {
            try {
              // 验证URL
              new URL(url);

              urlSection.classList.remove("hidden");
              pageUrl.value = url;
              openUrlBtn.href = url;

              // 添加延迟选择
              setTimeout(() => {
                try {
                  pageUrl.select();
                } catch (err) {
                  console.warn("自动选择URL失败:", err);
                }
              }, 100);

              console.log("URL已更新:", url);
            } catch (err) {
              console.error("无效的URL:", err);
              urlSection.classList.add("hidden");
            }
          }
        }
      }

      // 读取文件内容
      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = async (event) => {
            try {
              // 检查文件类型
              if (
                file.type ===
                  "application/vnd.openxmlformats-officedocument.wordprocessingml.document" ||
                file.name.endsWith(".docx")
              ) {
                // 处理Word文档
                const arrayBuffer = event.target.result;
                const result = await mammoth.extractRawText({
                  arrayBuffer: arrayBuffer,
                });
                resolve(result.value);
              } else if (
                file.type === "application/msword" ||
                file.name.endsWith(".doc")
              ) {
                // 对于旧版.doc文件，显示提示
                reject(
                  new Error(
                    "暂不支持旧版Word文档(.doc)，请将文件另存为.docx格式"
                  )
                );
              } else {
                // 处理文本文件
                resolve(event.target.result);
              }
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = () => {
            reject(new Error("无法读取文件"));
          };

          // 根据文件类型选择读取方式
          if (
            file.type ===
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document" ||
            file.name.endsWith(".docx")
          ) {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file);
          }
        });
      }

      // 初始化深色模式
      function initDarkMode() {
        // 从本地存储获取主题设置，默认为亮色模式
        const currentTheme = localStorage.getItem("theme") || "light";

        // 同时检查系统偏好
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const themeToUse = currentTheme || (prefersDark ? "dark" : "light");

        console.log("初始化主题:", themeToUse);

        // 强制移除所有主题类并添加正确的主题类
        document.documentElement.classList.remove("dark", "light");
        document.documentElement.classList.add(themeToUse);

        // 更新主题切换按钮的状态
        updateThemeToggleButton(themeToUse === "dark");

        // 添加系统主题变化的监听
        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            // 只有在没有用户手动设置主题时才跟随系统
            if (!localStorage.getItem("theme")) {
              const newTheme = e.matches ? "dark" : "light";
              document.documentElement.classList.remove("dark", "light");
              document.documentElement.classList.add(newTheme);
              updateThemeToggleButton(newTheme === "dark");
            }
          });
      }

      // 更新主题切换按钮的状态
      function updateThemeToggleButton(isDark) {
        if (themeToggle) {
          // 根据当前主题更新按钮状态
          const moonIcon = themeToggle.querySelector(".fa-moon");
          const sunIcon = themeToggle.querySelector(".fa-sun");

          if (isDark) {
            moonIcon.classList.add("hidden");
            sunIcon.classList.remove("hidden");
          } else {
            moonIcon.classList.remove("hidden");
            sunIcon.classList.add("hidden");
          }
        }
      }

      // 加载保存的API配置
      function loadSavedApiConfig() {
        try {
          const savedConfig = localStorage.getItem("siliconFlowConfig");
          if (savedConfig) {
            const config = JSON.parse(savedConfig);

            // 填充表单
            if (apiKeyInput) apiKeyInput.value = config.apiKey || "";
            if (modelNameInput) modelNameInput.value = config.modelName || "";
            if (apiUrlInput) apiUrlInput.value = config.apiUrl || "";

            // 设置全局配置
            window.siliconFlowConfig = config;

            console.log("已加载保存的API配置");
            return true;
          }
        } catch (error) {
          console.error("加载API配置失败:", error);
        }
        return false;
      }

      // 清理HTML代码（移除Markdown标记）
      function cleanHtmlContent(htmlContent) {
        // 如果内容以 ```html 开头，需要去除标记
        if (htmlContent.trim().startsWith("```html")) {
          return htmlContent
            .replace(/^```html\s*/m, "")
            .replace(/```\s*$/m, "");
        }
        return htmlContent;
      }

      // 添加必要的CSS和框架
      function wrapWithStyles(htmlContent) {
        // 检查是否为完整HTML文档
        const isCompleteHtml =
          htmlContent.includes("<!DOCTYPE html>") &&
          htmlContent.includes("<html") &&
          htmlContent.includes("<head") &&
          htmlContent.includes("</head>") &&
          htmlContent.includes("<body") &&
          htmlContent.includes("</body>");

        // 如果是完整HTML，尝试注入样式但保留结构
        if (isCompleteHtml) {
          try {
            // 创建一个临时的DOM解析器
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, "text/html");

            // 确保有head标签
            const head = doc.head || doc.getElementsByTagName("head")[0];
            if (head) {
              // 添加所需的CSS和JS
              if (!htmlContent.includes("tailwindcss")) {
                const tailwindScript = doc.createElement("script");
                tailwindScript.src = "https://cdn.tailwindcss.com";
                head.appendChild(tailwindScript);
              }

              if (!htmlContent.includes("preline")) {
                const prelineLink = doc.createElement("link");
                prelineLink.href =
                  "https://cdn.jsdelivr.net/npm/preline@1.9.0/dist/preline.min.css";
                prelineLink.rel = "stylesheet";
                head.appendChild(prelineLink);

                const prelineScript = doc.createElement("script");
                prelineScript.src =
                  "https://cdn.jsdelivr.net/npm/preline@1.9.0/dist/preline.min.js";
                head.appendChild(prelineScript);
              }

              // 添加字体和暗色模式样式
              const customStyle = doc.createElement("style");
              customStyle.textContent = `
                body { font-family: 'Inter', sans-serif; }
                .prose img { margin: 0 auto; }
                @media (prefers-color-scheme: dark) {
                  html:not(.light) { background-color: #111827; color: #f9fafb; }
                }
              `;
              head.appendChild(customStyle);
            }

            // 获取修改后的HTML
            return new XMLSerializer().serializeToString(doc);
          } catch (e) {
            console.error("解析HTML失败，回退到默认包装:", e);
            // 如果解析失败，回退到默认包装方法
          }
        }

        // 如果不是完整HTML或解析失败，使用默认包装方法
        return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"><\/script>
  <link href="https://cdn.jsdelivr.net/npm/preline@1.9.0/dist/preline.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/preline@1.9.0/dist/preline.min.js"><\/script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .prose img { margin: 0 auto; }
    @media (prefers-color-scheme: dark) {
      html:not(.light) { background-color: #111827; color: #f9fafb; }
    }
    
    /* 优化代码高亮样式 */
    pre {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 1rem;
      overflow-x: auto;
    }
    
    pre code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    @media (prefers-color-scheme: dark) {
      pre {
        background-color: #1f2937;
        color: #f3f4f6;
      }
    }
  </style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
</head>
<body>
  ${htmlContent}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"><\/script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"><\/script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"><\/script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"><\/script>
  <script>
    // 初始化组件
    if (typeof Prism !== 'undefined') {
      Prism.highlightAll();
    }
    if (typeof HSStaticMethods !== 'undefined') {
      HSStaticMethods.autoInit();
    }
  <\/script>
</body>
</html>`;
      }

      // 主初始化函数
      function init() {
        console.log("初始化应用");
        initDomElements();
        initDarkMode();
        initEventListeners();
        initDownloadImageFeature();
        initAiGenerate();
        loadSavedApiConfig();

        // 默认选择文件上传
        setTimeout(() => {
          if (fileInputBtn) {
            fileInputBtn.click();
          }
        }, 100);
      }

      // 初始化下载图片功能
      function initDownloadImageFeature() {
        if (downloadImageBtn) {
          downloadImageBtn.addEventListener("click", async function () {
            try {
              // 获取HTML内容并清理
              const htmlContent = cleanHtmlContent(htmlCode.textContent);

              // 创建临时iframe
              const tempIframe = document.createElement("iframe");
              tempIframe.style.position = "fixed";
              tempIframe.style.top = "-9999px";
              tempIframe.style.width = "1200px";
              tempIframe.style.height = "900px";
              document.body.appendChild(tempIframe);

              // 添加样式和框架
              tempIframe.srcdoc = wrapWithStyles(htmlContent);

              // 等待iframe加载
              await new Promise((resolve) => (tempIframe.onload = resolve));
              await new Promise((resolve) => setTimeout(resolve, 1000));

              // 截图
              const canvas = await html2canvas(
                tempIframe.contentDocument.body,
                {
                  scale: 2,
                  useCORS: true,
                  allowTaint: true,
                  backgroundColor: "#ffffff",
                }
              );

              // 清理
              document.body.removeChild(tempIframe);

              // 下载
              canvas.toBlob(function (blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "converted-page.png";
                a.click();
                URL.revokeObjectURL(url);
              }, "image/png");
            } catch (error) {
              console.error("保存图片时出错:", error);
              alert("保存图片失败: " + error.message);
            }
          });
        }
      }

      // 初始化AI生成功能
      function initAiGenerate() {
        console.log("初始化AI生成功能");
        const aiGenerateBtn = document.getElementById("ai-generate-btn");
        const textContent = document.getElementById("text-content");

        if (!aiGenerateBtn || !textContent) {
          console.error("AI生成所需的DOM元素未找到");
          return;
        }

        // 修改AI生成按钮的状态
        function updateAiGenerateButtonState(isLoading) {
          const btn = document.getElementById("ai-generate-btn");
          const icon = btn.querySelector("i");
          const text = btn.querySelector("span");

          if (isLoading) {
            btn.disabled = true;
            btn.classList.add("loading");
            icon.classList.remove("fa-robot");
            icon.classList.add("fa-spinner", "fa-spin");
            text.textContent = "生成中...";
          } else {
            btn.disabled = false;
            btn.classList.remove("loading");
            icon.classList.remove("fa-spinner", "fa-spin");
            icon.classList.add("fa-robot");
            text.textContent = "AI生成";
          }
        }

        // AI生成按钮点击事件
        aiGenerateBtn.addEventListener("click", async function () {
          console.log("开始AI生成");
          const currentText = textContent.value.trim();

          // 验证输入长度
          if (currentText.length < 5) {
            alert("请至少输入5个字作为提示");
            return;
          }

          try {
            // 更新按钮状态为加载中
            updateAiGenerateButtonState(true);

            // 检查API配置
            if (!window.siliconFlowConfig) {
              if (!loadSavedApiConfig()) {
                throw new Error("请先配置API");
              }
            }

            const { apiKey, modelName, apiUrl } = window.siliconFlowConfig;
            console.log("使用API配置:", { modelName, apiUrl });

            // 构建提示词
            const prompt = `请基于以下内容，生成一段相关的、内容丰富、逻辑清晰的文字（保持相同的主题和风格）：${currentText}`;

            // 调用API生成内容
            let generatedContent = "";
            await window.siliconFlow.callAPI(
              prompt,
              apiKey,
              modelName,
              apiUrl,
              (chunk, fullContent) => {
                // 实时更新文本框内容
                generatedContent = fullContent;
                textContent.value = currentText + "\n\n" + generatedContent;

                // 触发input事件以更新字符计数
                const event = new Event("input");
                textContent.dispatchEvent(event);

                // 滚动到底部
                textContent.scrollTop = textContent.scrollHeight;

                console.log("收到新内容");
              }
            );

            console.log("生成完成");
          } catch (error) {
            console.error("AI生成失败:", error);
            alert("生成失败: " + error.message);
          } finally {
            // 恢复按钮状态
            updateAiGenerateButtonState(false);
          }
        });

        console.log("AI生成功能初始化完成");
      }

      // 当DOM加载完成后初始化应用
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }

      // 下载文件函数
      function downloadFile(content, fileName, contentType) {
        const a = document.createElement("a");
        const file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      }
    </script>
  </body>
</html>
